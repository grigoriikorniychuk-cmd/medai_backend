# Changelog

## 1.0.0 (2025-05-10)

### Добавлено

- Первоначальная реализация модульной структуры бота
- Функциональность регистрации клиник
- Функциональность работы со звонками из AmoCRM
- Функциональность генерации и скачивания отчетов
- Обработка транскрибации и анализа звонков
- Клавиатуры для удобной навигации
- Улучшенная обработка ошибок
- Логирование для отладки
- Исправлены проблемы с FSM и обработкой текстовых сообщений
- Добавлены хэлперы для работы с API
- Отключение DEBUG-сообщений от MongoDB для уменьшения шума в логах

### Оптимизировано

- Модульная структура проекта с четким разделением ответственности
- Типизированные API функции
- Оптимизирован порядок регистрации обработчиков
- Улучшена обработка дат
- Улучшено отображение информации о звонках
- Повышено удобство пользования ботом

### Технические детали

- Использование библиотеки aiogram 3.x
- Интеграция с MongoDB для хранения пользовательских данных
- Взаимодействие с REST API бэкенда
- Клавиатуры с выбором даты, сделок и действий над звонками

## 2025-05-07

### Добавлено

- Реализована главная клавиатура бота с основными командами для быстрого доступа
- Добавлены обработчики для кнопок главной клавиатуры
- Все обработчики обновлены для показа главной клавиатуры при возврате в главное меню
- Кнопка "Главная" теперь сбрасывает состояние и возвращает пользователя на начальный экран

### Улучшено

- Улучшена навигация между разделами бота с помощью постоянной главной клавиатуры
- Повышено удобство использования бота для новых пользователей благодаря наглядным кнопкам
- Обновлены текстовые сообщения для лучшего взаимодействия с клавиатурой

## 2025-05-06

### Исправлено

- Исправлена ошибка "зависания" состояний FSM при вводе неверного формата даты - добавлен автоматический сброс состояния и перезапуск команды
- Добавлена обработка текстовой команды "Отмена" в дополнение к кнопке отмены
- Реализованы обработчики для кнопок навигации "Назад" в интерфейсе бота
- Улучшена логика обработки ошибок ввода, предотвращающая зацикливание состояний FSM

### Улучшено

- Добавлены более понятные сообщения о возможности использования /cancel для отмены операции
- Восстановлена корректная навигация между экранами с выбором даты, списком сделок и звонками

## 2025-05-05

### Исправлено

- Исправлена критическая ошибка в обработке URL транскрибаций - восстановлена корректная работа с URL-путями, возвращаемыми сервером в формате `/api/transcriptions/filename.txt/download`
- Улучшена логика обработки URL в функции download_transcription для поддержки всех вариантов путей и URL, возвращаемых сервером

## 2025-05-04

### Исправлено

- Исправлена ошибка в обработчике выбора звонка - обновлена функция make_call_actions_keyboard для поддержки как одиночных объектов, так и списков
- Исправлено несоответствие сигнатуры обработчика ошибок требованиям aiogram 3.x
- Добавлена корректная обработка дат в различных форматах при отображении информации о звонке
- Добавлен HTML-парсинг при отправке сообщений с форматированием

### Улучшено

- Добавлена более надежная обработка случаев, когда API возвращает данные в неожидаемом формате
- Улучшена отказоустойчивость при выборе звонка и работе с датами

## 2025-05-03

### Исправлено

- Исправлена проблема с ошибками при транскрибации звонков - теперь бот корректно обрабатывает асинхронные операции и ожидает завершения транскрибации
- Добавлена проверка наличия URL при скачивании отчетов
- Увеличен таймаут для операций загрузки/транскрибации до 5 минут
- Исправлен URL для скачивания транскрибаций - теперь используется URL непосредственно из ответа API
- Улучшена обработка ошибок при синхронизации звонков с AmoCRM
- Исправлена обработка даты при конвертации из пользовательского формата в формат API
- Модифицированы серверные эндпоинты API для поддержки дат в формате ДД.ММ.ГГГГ

### Улучшено

- Полностью переработан процесс транскрибации звонков - добавлен механизм активного ожидания с индикатором прогресса
- Бот теперь периодически проверяет статус транскрибации на сервере и отображает время ожидания
- После завершения транскрибации автоматически предоставляется ссылка для скачивания
- Удалены лишние шаги в интерфейсе для улучшения пользовательского опыта
- Унифицирован интерфейс для скачивания файлов - везде используется кнопка с URL вместо отправки текстовой ссылки
- После успешной транскрибации звонка сразу показываются кнопки для скачивания звонка и транскрибации
- Добавлено автоматическое определение наличия транскрибации для звонков
- Информация о звонке теперь содержит статус транскрибации
- Добавлена поддержка дополнительных форматов даты при вводе
- Более информативные сообщения об ошибках с рекомендациями по их устранению
- Расширено логирование для облегчения отладки проблем с API
- Оптимизирован API-эндпоинт получения звонков - удалены лишние параметры limit и skip, теперь запрос всегда возвращает все звонки за выбранный период
- Добавлена фильтрация звонков по client_id на уровне API для оптимизации запросов и защиты данных от несанкционированного доступа
