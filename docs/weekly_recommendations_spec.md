# –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è: –û–±—â–∏–µ –Ω–µ–¥–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç **–æ–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏** –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ä–µ–¥–Ω–∏—Ö –±–∞–ª–ª–æ–≤ –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º –∑–∞ –ø–µ—Ä–∏–æ–¥. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è —Å —É—á—ë—Ç–æ–º –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ –ø–æ –∑–æ–Ω–∞–º.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

```
MongoDB (calls.metrics)
        ‚îÇ
        ‚îú‚îÄ‚îÄ‚ñ∫ generate_report.py ‚îÄ‚îÄ‚ñ∫ PDF —Ç–∞–±–ª–∏—Ü–∞ "–°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –æ—Ü–µ–Ω–æ–∫"
        ‚îÇ
        ‚îú‚îÄ‚îÄ‚ñ∫ recommendation_analysis_service.py ‚îÄ‚îÄ‚ñ∫ –û–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (LLM)
        ‚îÇ
        ‚îî‚îÄ‚îÄ‚ñ∫ postgres_exporter.py ‚îÄ‚îÄ‚ñ∫ PostgreSQL ‚îÄ‚îÄ‚ñ∫ DataLens
```

## –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ –ø–æ –∑–æ–Ω–∞–º

| –ó–æ–Ω–∞ | –ë–∞–ª–ª—ã | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-------|----------|
| **–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã** | 8-10 | –ö—Ä–∏—Ç–µ—Ä–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å |
| **–ó–æ–Ω—ã —Ä–æ—Å—Ç–∞** | 5-7 | –ö—Ä–∏—Ç–µ—Ä–∏–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è |
| **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–ª–∞–±—ã–µ –º–µ—Å—Ç–∞** | 0-4 | –ö—Ä–∏—Ç–µ—Ä–∏–∏, —Ç—Ä–µ–±—É—é—â–∏–µ —Å—Ä–æ—á–Ω–æ–≥–æ –≤–Ω–∏–º–∞–Ω–∏—è |

## –ü—Ä–∞–≤–∏–ª–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π

### 1. –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã (8-10 –±–∞–ª–ª–æ–≤)
- –£–∫–∞–∑–∞—Ç—å –∫–∞–∫–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ —ç—Ç–æ–π –∑–æ–Ω–µ
- –î–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ **–∫–∞–∫ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å** –≤—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å
- –ù–ï —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å —É–ª—É—á—à–µ–Ω–∏—è –¥–ª—è —ç—Ç–∏—Ö –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤

### 2. –ó–æ–Ω—ã —Ä–æ—Å—Ç–∞ (5-7 –±–∞–ª–ª–æ–≤)
- –£–∫–∞–∑–∞—Ç—å –∫–∞–∫–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ —ç—Ç–æ–π –∑–æ–Ω–µ
- –î–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ **—á—Ç–æ –Ω—É–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å** –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ "–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã"
- –ü—Ä–∏–≤–µ—Å—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã —Ñ—Ä–∞–∑ –∏ –¥–µ–π—Å—Ç–≤–∏–π

### 3. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–ª–∞–±—ã–µ –º–µ—Å—Ç–∞ (0-4 –±–∞–ª–ª–∞)
- –£–∫–∞–∑–∞—Ç—å –∫–∞–∫–∏–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ —ç—Ç–æ–π –∑–æ–Ω–µ
- –î–∞—Ç—å **—Å—Ä–æ—á–Ω—ã–µ –º–µ—Ä—ã** –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è ‚Äî –Ω–∞ —ç—Ç–∏—Ö –∫—Ä–∏—Ç–µ—Ä–∏—è—Ö

## –†–∞—Å—á—ë—Ç —Å—Ä–µ–¥–Ω–∏—Ö –±–∞–ª–ª–æ–≤

### –§–æ—Ä–º—É–ª–∞
```python
avg_score = sum(all_values_for_criterion) / count(all_values_for_criterion)
```

### –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö
- –ö–æ–ª–ª–µ–∫—Ü–∏—è: `calls`
- –ü–æ–ª–µ: `metrics` (dict)
- –§–∏–ª—å—Ç—Ä: `created_date_for_filtering` –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ –ø–µ—Ä–∏–æ–¥–∞
- –§–∏–ª—å—Ç—Ä: `client_id` = ID –∫–ª–∏–Ω–∏–∫–∏

### –ö—Ä–∏—Ç–µ—Ä–∏–∏
```python
CRITERIA = [
    'greeting',              # –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
    'patient_name',          # –ò–º—è –ø–∞—Ü–∏–µ–Ω—Ç–∞
    'appeal',                # –ê–ø–µ–ª–ª—è—Ü–∏—è
    'needs_identification',  # –í—ã—è–≤–ª–µ–Ω–∏–µ –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π
    'service_presentation',  # –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è —É—Å–ª—É–≥–∏
    'clinic_presentation',   # –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –∫–ª–∏–Ω–∏–∫–∏
    'doctor_presentation',   # –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –≤—Ä–∞—á–∞
    'patient_booking',       # –ó–∞–ø–∏—Å—å –Ω–∞ –ø—Ä–∏–µ–º
    'clinic_address',        # –ê–¥—Ä–µ—Å –∫–ª–∏–Ω–∏–∫–∏
    'passport',              # –ü–∞—Å–ø–æ—Ä—Ç
    'next_step',             # –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥
    'initiative',            # –ò–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞
    'speech',                # –†–µ—á—å
    'expertise',             # –≠–∫—Å–ø–µ—Ä—Ç–Ω–æ—Å—Ç—å
    'price',                 # –¶–µ–Ω–∞
    'emotional_tone',        # –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–Ω
    'objection_handling',    # –†–∞–±–æ—Ç–∞ —Å –≤–æ–∑—Ä–∞–∂–µ–Ω–∏—è–º–∏
]
```

## API Endpoints

### –ü–æ–ª—É—á–∏—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
```
GET /api/analyze-recommendations?client_id=<UUID>&start_date=YYYY-MM-DD&end_date=YYYY-MM-DD
```

### –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è (–±–µ–∑ –∫—ç—à–∞)
```
GET /api/analyze-recommendations?client_id=<UUID>&start_date=YYYY-MM-DD&end_date=YYYY-MM-DD&force_refresh=true
```

## –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞

```json
{
  "summary_points": [
    "1. –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –ò–Ω–∏—Ü–∏–∞—Ç–∏–≤–∞ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –æ—Ç–ª–∏—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã",
    "2. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —É–ª—É—á—à–∏—Ç—å —Ä–∞–±–æ—Ç—É —Å –ü–∞—Å–ø–æ—Ä—Ç –∏ –ê–¥—Ä–µ—Å –∫–ª–∏–Ω–∏–∫–∏"
  ],
  "overall_summary": "# üìä –û–±—â–∏–µ –≤—ã–≤–æ–¥—ã\n\n## ‚úÖ –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã (8-10 –±–∞–ª–ª–æ–≤)\n..."
}
```

## –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –∫—ç—à–∏—Ä—É—é—Ç—Å—è –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ `recommendation_analysis_results`:
```json
{
  "client_id": "UUID",
  "start_date": "2025-11-25",
  "end_date": "2025-12-01",
  "analysis_data": { ... },
  "avg_scores": { "greeting": 8.5, ... },
  "classification": { "strong": [...], "growth": [...], "critical": [...] },
  "created_at": "2025-12-02T12:00:00Z"
}
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞—Å—á—ë—Ç–æ–≤
```bash
cd /home/mpr0/Develop/medai_backend
source venv/bin/activate
python tests/test_weekly_scores_calculation.py \
  --client_id "9476ab76-c2a6-4fef-b4f8-33e1284ef261" \
  --start_date 2025-11-25 \
  --end_date 2025-12-01
```

### –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–µ—Å—Ç:
1. –°—Ä–µ–¥–Ω–∏–µ –±–∞–ª–ª—ã –∏–∑ MongoDB —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å PostgreSQL
2. –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ –∑–æ–Ω–∞–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –±–∞–ª–ª–∞–º
3. –ù–µ—Ç –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ —Å –±–∞–ª–ª–æ–º 0-4 –≤ "–°–∏–ª—å–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω–∞—Ö"
4. –ù–µ—Ç –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ —Å –±–∞–ª–ª–æ–º 8-10 –≤ "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö"

## –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ —Å DataLens
DataLens –º–æ–∂–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ —Ü–∏—Ñ—Ä—ã, –µ—Å–ª–∏:
1. PostgreSQL –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω ‚Äî –∑–∞–ø—É—Å—Ç–∏—Ç—å `/api/postgres/sync-now`
2. –í DataLens –µ—Å—Ç—å –¥–æ–ø. –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ –ø–æ–ª—è —Å –¥—Ä—É–≥–∏–º–∏ —Ñ–æ—Ä–º—É–ª–∞–º–∏
3. –†–∞–∑–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

### –†–µ—à–µ–Ω–∏–µ
1. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å PostgreSQL –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π –æ—Ç—á—ë—Ç–∞
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ (MongoDB) –¥–ª—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
3. –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å —Ç–æ—á–Ω—ã–µ –±–∞–ª–ª—ã –≤ –ø—Ä–æ–º–ø—Ç LLM

## Changelog

- **2025-12-02**: –î–æ–±–∞–≤–ª–µ–Ω —Ä–∞—Å—á—ë—Ç —Å—Ä–µ–¥–Ω–∏—Ö –±–∞–ª–ª–æ–≤ –∏–∑ MongoDB –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞ LLM
- **2025-12-02**: –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ –ø–æ –∑–æ–Ω–∞–º (8-10, 5-7, 0-4)
- **2025-12-02**: –û–±–Ω–æ–≤–ª—ë–Ω –ø—Ä–æ–º–ø—Ç —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ –∑–æ–Ω–∞–º
- **2025-12-02**: –î–æ–±–∞–≤–ª–µ–Ω —Ç–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞—Å—á—ë—Ç–æ–≤
