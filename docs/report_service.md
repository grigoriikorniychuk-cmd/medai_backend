Общая структура сервиса отчетов по звонкам
В системе существует класс CallReportService, который генерирует отчеты о звонках с различными статистическими данными и визуализациями. Сервис создает PDF-отчет, содержащий:
Титульную страницу с логотипом клиники и сводной статистикой
График количества звонков по администраторам
График длительности звонков по администраторам
Линейный график оценок по неделям
График динамики звонков по источникам трафика
График звонков по типу
Круговую диаграмму распределения звонков по источникам
Тепловую карту звонков по дням недели и времени суток
Основные методы для создания графиков
Сервис включает несколько основных методов для генерации различных типов графиков:
\_create_calls_by_admin_chart - создает столбчатую диаграмму количества звонков по администраторам
\_create_duration_by_admin_chart - создает столбчатую диаграмму общей длительности звонков по администраторам
\_create_scores_by_week_chart - создает линейный график оценок звонков по неделям
\_create_traffic_line_chart - создает линейный график динамики звонков по источникам трафика
\_create_call_types_line_chart - создает линейный график звонков по типам
\_create_traffic_pie_chart - создает круговую диаграмму распределения звонков по источникам
\_create_calls_heatmap - создает тепловую карту звонков по дням недели и времени суток
Детали реализации графика оценок по неделям
Метод \_create_scores_by_week_chart извлекает данные о датах звонков и оценках из коллекции MongoDB. Он:
Группирует звонки по неделям
Вычисляет средние значения оценок для каждого критерия по неделям
Строит линейный график, где:
Ось X: недели (формат "Неделя N")
Ось Y: оценки (от 0 до 10)
Каждая линия представляет отдельный критерий оценки
График использует библиотеки matplotlib и seaborn для визуализации, сохраняя результат в объект BytesIO для дальнейшего включения в PDF-отчет.
Сводная статистика
Метод \_create_summary_statistics рассчитывает и форматирует следующие данные:
Период анализа
Общее количество звонков
Количество входящих и исходящих звонков
Средняя и общая длительность звонков
Процент конверсии в запись
FG% звонков (процент звонков с оценкой 7 и выше)
Средняя скорость обработки
Технические особенности
Графики генерируются с помощью matplotlib и seaborn
Для создания PDF используется библиотека ReportLab
Данные извлекаются из MongoDB и преобразуются в pandas DataFrame для анализа
Обработка выполняется асинхронно при помощи async/await
Все функции построения графиков имеют обработку ошибок и проверку наличия данных
Графики сохраняются в память в формате PNG
В файлах реализованы различные подходы к обработке данных и созданию графиков, включая группировку по различным параметрам, фильтрацию, агрегацию и визуализацию с помощью различных типов диаграмм.
